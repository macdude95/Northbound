name: Daily Portfolio Allocations

# Run when NYSE opens (9:30 AM ET = 14:30 UTC) Monday-Friday
on:
  schedule:
    - cron: '30 14 * * 1-5' # 9:30 AM ET = 14:30 UTC, Mon-Fri
  workflow_dispatch: # Manual trigger button

jobs:
  get-daily-allocations:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install mail utilities
        run: |
          sudo apt-get update
          sudo apt-get install -y msmtp mailutils

      - name: Get portfolio allocations
        id: allocations
        env:
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
        run: |
          # Generate strategy allocation string from portfolio config
          strategy_allocation=$(python3 -c "
          import json
          with open('portfolio_configs/current_portfolio.json', 'r') as f:
              config = json.load(f)
          strategies = config['strategies']
          allocation_str = ' '.join([f'{strategy}:{pct}' for strategy, pct in strategies.items()])
          print(allocation_str)
          ")

          # Get strategy breakdown for email
          breakdown=$(python scripts/get_allocations.py --breakdown $strategy_allocation 2>&1)
          echo "breakdown<<EOF" >> $GITHUB_OUTPUT
          echo "$breakdown" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Get full allocation data for copy/paste
          summary=$(python scripts/get_allocations.py $strategy_allocation 2>&1 | grep "^- " | sed 's/^- //' | tr '\n' '\n')
          if [ -z "$summary" ]; then
            summary="‚ùå ALLOCATION CALCULATION FAILED - MANUAL CHECK REQUIRED\\nError: Unable to calculate portfolio allocations. Please check system manually."
          fi
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$summary" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send email notification
        if: success()
        run: |
          SUBJECT="Daily Portfolio Allocations - $(date +%Y-%m-%d)"
          BODY="üöÄ Daily Portfolio Allocations - $(date +%Y-%m-%d)

          STRATEGY BREAKDOWN:
          ${{ steps.allocations.outputs.breakdown }}

          üì± Calculator: https://macdude95.github.io/Northbound/portfolio-calculator/

          [COPY BELOW FOR CALCULATOR]
          ${{ steps.allocations.outputs.summary }}
          [END COPY SECTION]

          --
          Northbound Trading System"

          # Configure msmtp for Gmail SMTP
          cat > ~/.msmtprc << EOF
          defaults
          tls on
          tls_starttls on
          tls_starttls on
          tls_trust_file /etc/ssl/certs/ca-certificates.crt
          account gmail
          host smtp.gmail.com
          port 587
          auth on
          user ${{ secrets.GMAIL_USERNAME }}
          password ${{ secrets.GMAIL_APP_PASSWORD }}
          from ${{ secrets.GMAIL_USERNAME }}
          account default : gmail
          EOF

          chmod 600 ~/.msmtprc

          # Send email using msmtp
          echo "$BODY" | msmtp -t <<EOF
          To: ${{ secrets.EMAIL_ADDRESS }}
          From: ${{ secrets.GMAIL_USERNAME }}
          Subject: $SUBJECT
          Content-Type: text/plain

          $BODY
          EOF

          echo "Email sent successfully to ${{ secrets.EMAIL_ADDRESS }}"

      - name: Log results
        if: always()
        run: |
          echo "Daily allocation run completed at $(date)"
          echo "Summary: ${{ steps.allocations.outputs.summary }}"
          echo "Full output length: $(echo '${{ steps.allocations.outputs.full_output }}' | wc -c) characters"
